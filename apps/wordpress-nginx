#!/bin/bash

# Add this at the begining of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

checkOs
checkRootUser
runOnceCheck

# checking app has all services dependencies
checkTagExist nginx.success
checkTagExist mysqld.success
checkTagExist maild.success

MY_PATH="`dirname \"$0\"`"
WP_PATH="/var/www/html"
WPID=`shuf -i 100000-999999 -n 1`
USEREMAIL=$(cat /root/guest.conf | grep email= | cut -d'=' -f2)
USERPASS=$(cat /root/guest.conf | grep password= | cut -d'=' -f2)

cp $MY_PATH/../tweaks/extras/wordpress-nginx/wordpress-nginx-config /etc/nginx/sites-available/default 
service nginx restart

# Downloading wordpress and installing
mysql -e "create database cloudwm_${WPID};"
mysql -e "grant all privileges on cloudwm_${WPID}.* to wp_${WPID}@'localhost' identified by '"${USERPASS}"';"
mysql -e "flush privileges;"

wp core download --path=${WP_PATH} --locale=en_US --allow-root | log

wp config create --dbname=cloudwm_${WPID} --dbuser=wp_${WPID} --dbpass=securepswd --locale=en_US --allow-root | log

wp core multisite-install --title="Welcome to the WordPress" --admin_user="admin" --admin_password="${USERPASS}" --admin_email="${USEREMAIL}" --path=${WP_PATH} --allow-root | log

## fix permissions
sudo chown -R www-data:www-data /var/www/html

tagScript success

exit 0
