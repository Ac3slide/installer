#!/bin/bash

# Add this at the begining of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

checkOs
checkRootUser
runOnceCheck

# checking app has all services dependencies
checkTagExist nginx.success
checkTagExist mysqld.success
checkTagExist php.success
checkTagExist maild.success
checkTagExist wp-cli.success

## set variables and get guest.conf details
rootDir=$(rootDir)
WP_PATH="/var/www/html"
WPID=`shuf -i 100000-999999 -n 1`

IPADDR=$WANIP1

# set nginx config
cp $rootdir/tweaks/extras/wordpress-nginx/wordpress-nginx-config /etc/nginx/sites-available/default | log
service nginx restart | log

waitOrStop 0

# create mysql user and permissions
mysql -u root -p"${ADMINPASSWORD}" -e "create database cloudwm_${WPID};"
mysql -u root -p"${ADMINPASSWORD}" -e "grant all privileges on cloudwm_${WPID}.* to wp_${WPID}@'localhost' identified by '"${ADMINPASSWORD}"';"
mysql -u root -p"${ADMINPASSWORD}" -e "flush privileges;"

waitOrStop 0

# Downloading wordpress and installing
wp core download --path=${WP_PATH} --locale=en_US --allow-root | log
waitOrStop 0

wp config create --dbname=wordpress_${WPID} --dbuser=wp_${WPID} --dbpass=${ADMINPASSWORD} --locale=en_US --path=${WP_PATH} --allow-root | log
waitOrStop 0

wp core multisite-install --url=http://${IPADDR} --title="Welcome to the WordPress" --admin_user="admin" --admin_password="${ADMINPASSWORD}" --admin_email="${ADMINEMAIL}" --path=${WP_PATH} --allow-root | log
waitOrStop 0

## fix permissions
sudo chown -R www-data:www-data ${WP_PATH}

tagScript success

exit 0
