#!/bin/bash

if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

echo "Setting jenkins repository and key" | log
curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | apt-key add -
waitOrStop 0
echo "deb https://pkg.jenkins.io/debian-stable binary/" > /etc/apt/sources.list.d/jenkins.list

echo "Installing openjdk" | log
apt update
apt install -y openjdk-8-jre-headless
waitOrStop 0

echo "Installing jenkins" | log
apt update
apt install -y jenkins
waitOrStop 0

echo "Tweaking server settings" | log
sed -i 's/HTTP_PORT=8080/HTTP_PORT=9090/g' /etc/default/jenkins
sed -i '/JAVA_ARGS="-Djava.net.preferIPv4Stack=true"/s/^#//g' /etc/default/jenkins

echo "Restarting service" | log
systemctl restart jenkins

echo "Adding descriptions" | log
unlockkey=`cat /var/lib/jenkins/secrets/initialAdminPassword`
descriptionAppend "Initial setup URL: http://${SERVERIP}:9090"
descriptionAppend "Unlock key: $unlockkey"
descriptionAppend " "
descriptionAppend "If main page is blank after initial setup, restart the server:"
descriptionAppend "# systemctl restart jenkins"
descriptionAppend " "

tagScript success

exit 0
