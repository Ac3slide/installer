#!/bin/bash

if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

checkTagExist php.success
checkTagExist nginx.success
checkTagExist mysqld.success
checkTagExist nginx-enable-php-ssl.success

rootDir=$(rootDir)
appPath=/var/www/html
appVersion=2.3.1

echo "Creating Magento Database" | log

echo "mysql --defaults-file=/root/.my.cnf -h localhost -e \"create database magentodb;\"" | sh
echo "mysql --defaults-file=/root/.my.cnf -h localhost -e \"create user magentouser@localhost identified by '${ADMINPASSWORD}';\"" | sh
echo "mysql --defaults-file=/root/.my.cnf -h localhost -e \"grant all privileges on magentodb.* to magentouser@localhost identified by '${ADMINPASSWORD}';\"" | sh
echo "mysql --defaults-file=/root/.my.cnf -h localhost -e \"flush privileges;\"" | sh

echo "Installing Composer for machine" | log
apt install composer -y | log
waitOrStop 0
checkPackageInstalled composer

echo "Downloading Magento ${appVersion} from github repo" | log
mkdir -p $appPath
# mkdir -p temp
cd temp
# curl -o 2.3.0.tar.gz https://codeload.github.com/magento/magento2/tar.gz/2.3.0
curlDownload https://codeload.github.com/magento/magento2/tar.gz/$appVersion $appVersion.tar.gz | log
waitOrStop 0
mv $appVersion.tar.gz $appPath

echo "Extracting Magento to ${appPath}" | log
tar -xzvf $appPath/$appVersion.tar.gz -C $appPath/ --strip 1
waitOrStop 0
rm -f $appPath/$appVersion.tar.gz

echo "Setting permissions for Magento" | log
cd $appPath
find var vendor pub/static pub/media app/etc -type f -exec chmod g+w {} \;
find var vendor pub/static pub/media app/etc -type d -exec chmod g+ws {} \;
chown -R www-data:www-data .
chmod u+x bin/magento

echo "Installing Composer dependencies for Magento" | log
cd $appPath
export COMPOSER_HOME=/root
composer install -v | log
waitOrStop 0

echo "Installing Magento" | log
$appPath/bin/magento setup:install --base-url-secure=https://${SERVERIP}/ --db-host=localhost --db-name=magentodb --db-user=magentouser --db-password=${ADMINPASSWORD} --admin-firstname=admin --admin-lastname=admin --admin-email=${ADMINEMAIL} --admin-user=admin --admin-password=${ADMINPASSWORD} --language=en_US --currency=USD --timezone=America/Chicago --use-rewrites=1 --use-secure=1 --use-secure-admin=1 | log

ADMIN_URI=`grep "Admin URI:" $(rootDir)/temp/*.log | rev | cut -d ' ' -f 1 | rev`
# ADMIN_URI=`php /var/www/html/bin/magento info:adminuri | rev | cut -d ' ' -f 1 | rev`


echo "Verifying permissions for Magento" | log
cd $appPath
find var vendor pub/static pub/media app/etc -type f -exec chmod g+w {} \;
find var vendor pub/static pub/media app/etc -type d -exec chmod g+ws {} \;
chown -R www-data:www-data .
chmod u+x bin/magento

echo "disable sign static files and force cache refresh" | log
cd $appPath
bin/magento config:set dev/static/sign 0
curl ${SERVERIP} > /dev/null
waitOrStop 0
bin/magento setup:static-content:deploy -f
bin/magento cache:clean
waitOrStop 0

echo "setting nginx config" | log
# main magento config
cp $rootDir/tweaks/extras/magento-nginx/magento-nginx-config /etc/nginx/sites-available/magento
# specific configs supplied by magento install, included by main magento config
mkdir -p /etc/nginx/config
cp $appPath/nginx.conf.sample /etc/nginx/config/magento.conf.sample
# tweak locations in magento config to allow for user themes and folders
tweakFilePath=$rootDir/tweaks/extras/magento-nginx/magento-locations-allow-custom
perl -i -p0e 's/location \/ .*?args;\n}/`cat $ARGV[0]`/se' -- /etc/nginx/config/magento.conf.sample "$tweakFilePath"
# Symlink magento vhost
ln -s /etc/nginx/sites-available/magento /etc/nginx/sites-enabled/magento
# Remove default vhosts
rm -f /etc/nginx/sites-available/default
rm -f /etc/nginx/sites-available/default-ssl
rm -f /etc/nginx/sites-enabled/default
rm -f /etc/nginx/sites-enabled/default-ssl

systemctl restart nginx

descriptionAppend "Magento Admin URI: https://${SERVERIP}${ADMIN_URI}"
descriptionAppend "Magento Admin Email: ${ADMINEMAIL}"
descriptionAppend "Magento Admin User: admin"
descriptionAppend "Magento Admin Password: ${ADMINPASSWORD}" 
descriptionAppend " "

tagScript success

exit 0
