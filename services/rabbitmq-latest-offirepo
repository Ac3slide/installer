#!/bin/bash

if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

echo "Add repository" | log

apt-key adv --keyserver "hkps.pool.sks-keyservers.net" --recv-keys "0x6B73A36E6026DFCA"
echo "deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang" | tee /etc/apt/sources.list.d/bintray.rabbitmq.list
echo "deb https://dl.bintray.com/rabbitmq/debian bionic main" >> /etc/apt/sources.list.d/bintray.rabbitmq.list
apt update

echo "Install Erlang & Rabbitmq" | log

apt install erlang-nox -y
waitOrStop 0

apt install rabbitmq-server -y
waitOrStop 0

# echo "tweak file desc limit to use machine" | log
# run ulimit -S -n 4096?
# edit /etc/security/limits.conf to persist

echo "starting Rabbitmq service" | log

systemctl enable rabbitmq-server
systemctl start rabbitmq-server

tagScript success

exit 0
