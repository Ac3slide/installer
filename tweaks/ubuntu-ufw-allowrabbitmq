#!/bin/bash
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

checkTagExist ufw.success
ports=(4369 5671:5672/tcp 15672 25672 35672:35862/tcp 15674 15675 1883 8883 61613:61614/tcp)

# Check if LAN VLAN exists, if yes, open only LAN VLAN subnets in the firewall
if [ ! -z "$CWM_LANNICIDS" ]; then

    for ip in $CWM_LANNICIDS; do

        # ipvar="ip$ip" WRONG!
        subnet=`ip -o -f inet addr show | awk '/scope global/ {print $4}' | grep ${!ipvar}`

        for port in "${ports[@]}"; do
        
            ufw allow in to $subnet port $port

        done

        unset ipvar
        unset subnet
    
    done

else

    for port in "${ports[@]}"; do
    
        ufw allow $port

    done

fi

ufw status | log

tagScript success
