
#!/bin/bash

# Add this at the begining of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

runOnceCheck

cronFilename=/etc/cron.daily/installer-autoremove-old-logs
minSpaceLeftKbytes=1000000
minLogSizeKbytes=10000

if [ ! -f "$cronFilename" ];
then
cat << EOF > ${cronFilename}

#!/bin/bash

availablespace="\$(df / | awk 'NR==2{print \$4}')"

if [ "\$availablespace" -lt "${minSpaceLeftKbytes}" ]; then

    largeFilesList="\$(find /var/log/ -type f -size +${minLogSizeKbytes}k | sort | xargs file)"

    # Find text files and empty them
    textFiles="\$(printf "\$largeFilesList" | tr ':' ' ' | grep -i text)"
    printf "\$textFiles" | awk '{ print "emptying "\$1 }'
    printf "\$textFiles" | awk '{ print \$1 }' | xargs truncate --size 0

    # Find gzipped log files and remove them
    gzipFiles="\$(printf "\$largeFilesList" | tr ':' ' ' | grep -i gzip)"
    printf "\$gzipFiles" | awk '{ print "deleting "\$1 }'
    printf "\$gzipFiles" | awk '{ print \$1 }' | xargs rm -f

    echo "autoremove-old-logs was fired" >> /root/autoremove.log
fi

EOF
chmod +x $cronFilename
fi

tagScript success
